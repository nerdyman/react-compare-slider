name: CI

on:
  push:
    branches: [main]
  pull_request:
    types:
      - opened
      - synchronize
  workflow_dispatch:

jobs:
  build:
    name: Build, lint and test
    runs-on: ubuntu-latest

    steps:
      - name: üõí Checkout repo
        uses: actions/checkout@v6

      - name: üì¶ Setup pnpm
        uses: pnpm/action-setup@v4

      - name: ‚öíÔ∏è Use Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
          cache: "pnpm"

      - name: üì¶ Install Dependencies
        run: npm run bootstrap

      - name: üö¶ Lint
        run: pnpm run lint

      - name: üî® Build
        run: pnpm run --filter react-compare-slider build

      - name: üë∑ Build Example Project
        run: pnpm run --filter @this/example build

      - name: üïµÔ∏è Check Package Configuration
        run: pnpm run --filter react-compare-slider check:package

      - name: üé≠ Install Playwright
        run: pnpx playwright install --with-deps

      - name: üß™ Test
        run: pnpm run test:ci

      - name: üßä SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v7
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=nerdyman
            -Dsonar.projectKey=nerdyman_react-compare-slider
            -Dsonar.projectBaseDir=docs/storybook/coverage
            -Dsonar.sources=../../lib/src
            -Dsonar.inclusions=**/*.js,**/*.jsx,**/*.ts,**/*.tsx,**/*.css,**/*.yml,**/*.yaml
            -Dsonar.javascript.lcov.reportPaths=docs/storybook/coverage/lcov.info

      - name: ü§è Compressed Size Action
        uses: preactjs/compressed-size-action@v2
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"
          install-script: "pnpm install --frozen-lockfile --filter react-compare-slider"
          build-script: "build"
          cwd: lib
